## Overview

In this section, we will be provisioning/configuring the following:
1. Create Tencent Cloud Registry
2. Create Tencent Kubernetes Engine Cluster
3. Create Tencent Kubernetes Engine Node Pool
4. Deploy app2 with Tencent Kubernetes Engine
5. Create Public DNS Records
6. Configuring SSL

## 1. Create Tencent Cloud Registry

Container Registries serve as a place to store our Container Images  of our Applications. We'll be creating a container registry for the deployment of `app2` in this step.

Head to the **Tencent Container Registry** Product page and click on the **Instance** Tab

![](figures/05-app2.png)

Click on the **Create** button to create a new TCR Instance

![](figures/05-app2-1.png)

Name the instance as per the naming conventions stated

![](figures/05-app2-2.png)
![](figures/05-app2-3.png)

After we've created the registry, we can click on the **Quick Start Guide** Text

![](figures/05-app2-4.png)

### Configure TCR

We'll be brought to a setup page where we can configure various settings such as Public Network Access, Private Network VPC Access.

![](figures/05-app2-5.png)

When we've finished setting up the basic features, we'll be shown the follow credentials.
Copy the command in **Step 1** and execute it in your Terminal

![](figures/05-app2-6.png)
![](figures/05-app2-7.png)

### Building Docker Image

In this step, we will be pushing the image to the TCR Instance.

The steps of building the actual image can be found in the `README.md` of the respective applications. e.g. `tamlab/backend/app2/README.md`

After building the image, we should see the following.
Take note of the image tag associated with the image we've just built as we will be using it in the next step

![](figures/05-app2-8.png)

### Tagging and Pushing Docker Image to TCR

Now that we've built the container image, we can use the command `docker tag` to tag the image with your TCR link. You can find the link as shown below

![](figures/05-app2-9.png)

```bash
# Tag the docker image we just built
docker <image-tag-from-build-step> <your-tcr-url>/tamlab/app2-amd64:v1.0.0

# e.g. docker tag ruan-nj.tencentcloudcr.com/tamlab/app2-amd64:v1.0.0 ea54c6-lab.tencentcloudcr.com/tamlab/app2-amd64:v1.0.0
```

![](figures/05-app2-10.png)


Now we'll push the image that we just tagged using the `docker push` command

```bash
docker push tamlab-soonanntan-tcr.tencentcloudcr.com/tamlab/app2-amd64:[tag]
```

![](figures/05-app2-11.png)

We can now check if the image has been pushed properly by checking the Image Repository. You should see the newly pushed image tag.

![](figures/05-app2-12.png)
![](figures/05-app2-13.png)

## 2. Creating Tencent Kubernetes Engine Cluster

Head over to the **Tencent Kubernetes Engine** Product page and click on Cluster

![](figures/05-app2-14.png)

Select the **General cluster** option

![](figures/05-app2-15.png)

Create the cluster with the following Cluster Information fields

![](figures/05-app2-16.png)
![](figures/05-app2-17.png)

Setup the Component configuration

![](figures/05-app2-18.png)

Confirm the configurations and click on the **Done** button

![](figures/05-app2-19.png)

Wait for the Cluster to finish creating, it may take some time before it completes.

![](figures/05-app2-20.png)

When the Cluster has been created, click on the **Enter the cluster** button to continue configuring the cluster in the next steps

![](figures/05-app2-21.png)

## 3. Creating Tencent Kubernetes Engine Node Pool

On the Cluster details page, click on the **Worker node** section under **Node management**.
Click on **Create** to create a Node pool

![](figures/05-app2-22.png)

Select the General node pool option

![](figures/05-app2-23.png)

Setup the Node launch configuration as shown below

![](figures/05-app2-24.png)
![](figures/05-app2-25.png)
![](figures/05-app2-26.png)

You may need to wait for some time as the Node pool provisions the Node

![](figures/05-app2-27.png)

## 4. Deploying app2 with Tencent Kubernetes Engine

### Adding Cluster Subnet CIDR to Security Group

In order for TKE to access the MySQL Database and Redis Cache we provisioned previously, we will need to add the IP CIDR to the Security Group

We can see here our IP CIDR is `172.16.0.0/16`

![](figures/05-app2-28.png)

Head over to the **Security Group** page and add the IP CIDR as an Allow Rule

![](figures/05-app2-29.png)

### Change TCR Namespace Access Level

For the purpose of this lab, we will change the Namespace to Public access. This allows any system that has access to the registry to pull the image without the use of access credentials.

Note that if you wish to keep this as Private, you will need to configure Access Credentials for your TKE Deployment (or the container orchestrator of your choice)

Click on the **Pencil Icon** and change the option from Private to Public

![](figures/05-app2-30.png)
![](figures/05-app2-31.png)
![](figures/05-app2-32.png)

### Create Config Map

Navigate to the **ConfigMap** page under **Configuration management** and click on the **Create button**

![](figures/05-app2-33.png)

Name the **Config Map** as `vol-config-app2` and click on the **Import via file** button

![](figures/05-app2-34.png)

Navigate to your copy of the lab source codes and select the config file located at `tam-lab/backend/app2/configs/config.yaml`

![](figures/05-app2-35.png)

Modify the value for the `database` `endpoint` and `redis` `hostAddress` to the Private DNS we've configured for MySQL and Redis previously in the database section. It should look something like this.

After you've verified the configuration, click on the **Create ConfigMap** button

![](figures/05-app2-36.png)
![](figures/05-app2-37.png)

### Creating Deployment and Service (Load Balancer)

We'll now create a Deployment and Service to expose `app2` to the Public.
Click on the **Create** button to create a new deployment

![](figures/05-app2-38.png)

Fill in the name field as `app2` and click on the **Add volume** button

![](figures/05-app2-39.png)

Select the `vol-config-app2` ConfigMap we created and click on **OK**

![](figures/05-app2-40.png)

Enter the name of the container as `app2` and click on the **Select image** text button and **Select image tag** to select the images we previously pushed.

![](figures/05-app2-41.png)
![](figures/05-app2-42.png)

We'll be configuring the Service to expose `app2`
In this case, the service we'll be creating is a Public Load Balancer.

Take note of the follow terminologies when creating the Service
- Target Port: Port that the Container/Pod is listening on
- Node Port: Port that all Nodes are listening on (The port that the Load Balancer forwards the request to on the Node)
	- Note that there may be multiple Nodes so this needs to be the same for all Nodes
- Port: Port that the Load Balancer is listening on for requests

When you've confirmed the configuration are as desired, click on the **Create Deployment** button.

![](figures/05-app2-43.png)

After creating the Deployment, head to the Service page and you'll see a Load Balancer service provisioned `app2`. Copy the link of the Access entry point for the Load balancer and paste it into your Browser

![](figures/05-app2-44.png)

We can see that the page returns us a `Healthcheck` message, showing that it works properly.

![](figures/05-app2-45.png)

## 5. Creating Public DNS Records

Previously we've managed to deploy `app2` on TKE with the Load Balancer's Domain.
We will now create a record on our Public DNS to point to the Load Balancer.

As we have done for the `frontend` and `app1` deployment, we will also create another record for `app2` on our DNS Provider
- Host: `<code>-app2`
- Record Type: `CNAME`
- Record Value: `<load-balancer-domain-name>`

![](figures/05-app2-46.png)

After creating the record, you will be able to access the page at the record created.

![](figures/05-app2-47.png)

## 6. Configuring SSL

We'll now be configuring SSL for the Load Balancer

Click on the **Apply for free certificate** button

![](figures/05-app2-48.png)

We'll be using the domain with the follow convention `<code>-app2.<your-domain>.<tld>`
> e.g. `ea54c6-app2.tam-lab.xyz`

![](figures/05-app2-49.png)

Validate your domain by adding the CNAME Record

![](figures/05-app2-50.png)

Head to your DNS Provider and add the CNAME record as shown below

![](figures/05-app2-51.png)

Head back to the certificate application page, click on **Validate** and you should see the following

![](figures/05-app2-52.png)

After we've verified our domain and are issued the Certificate, we can see the certificate issued to us below.

![](figures/05-app2-53.png)

Navigate to the TKE Cluster Management page and look for the **Service** we've previously deployed

Click on **Update configuration**

![](figures/05-app2-54.png)

Change the Protocol to **TCP SSL** and **Port** to 443

Then click on the **create a new one** option to create a Kubernetes Secret Resource with the certificate we've just provisioned

![](figures/05-app2-55.png)

Select the Certificate we just provisioned and click **Create Secret**

![](figures/05-app2-56.png)

You should now be able to select the key we just Secret we just created under the **Secret** drop down selection.

Click on **Update access method** once you're satisfied with the configuration

![](figures/05-app2-57.png)

You should now be able to access the page with HTTPS instead of HTTP
> e.g. `https://ea54c6-app2.tam-lab.xyz`

![](figures/05-app2-58.png)
